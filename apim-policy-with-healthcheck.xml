<!--
    Azure API Management Policy for Load Balancing with Session Affinity and Circuit Breaker
    
    This policy provides:
    - Cookie-based session affinity (sticky sessions)
    - Health check monitoring with circuit breaker pattern
    - Automatic failover to healthy instances
    - Automatic recovery when instances return to health
    
    IMPORTANT: This policy should be applied at the API level.
    You also need to create a separate operation for "/health-monitor" that runs the health check policy.
-->
<policies>
    <inbound>
        <base />
        
        <!-- Cache key prefix for health check status -->
        <set-variable name="cacheKeyPrefix" value="backend-health-" />
        
        <!-- Define backend pool with health check endpoints -->
        <set-variable name="backends" value="@{
            return new JObject[] {
                new JObject() { 
                    ["url"] = "https://your-app-instance-1.azurecontainerapps.io",
                    ["health"] = "https://your-app-instance-1.azurecontainerapps.io/health",
                    ["id"] = "0"
                },
                new JObject() { 
                    ["url"] = "https://your-app-instance-2.azurecontainerapps.io",
                    ["health"] = "https://your-app-instance-2.azurecontainerapps.io/health",
                    ["id"] = "1"
                },
                new JObject() { 
                    ["url"] = "https://your-app-instance-3.azurecontainerapps.io",
                    ["health"] = "https://your-app-instance-3.azurecontainerapps.io/health",
                    ["id"] = "2"
                },
                new JObject() { 
                    ["url"] = "https://your-app-instance-4.azurecontainerapps.io",
                    ["health"] = "https://your-app-instance-4.azurecontainerapps.io/health",
                    ["id"] = "3"
                },
                new JObject() { 
                    ["url"] = "https://your-app-instance-5.azurecontainerapps.io",
                    ["health"] = "https://your-app-instance-5.azurecontainerapps.io/health",
                    ["id"] = "4"
                }
            };
        }" />
        
        <!-- Get list of healthy backends from cache -->
        <set-variable name="healthyBackends" value="@{
            var backends = (JObject[])context.Variables["backends"];
            var healthyList = new System.Collections.Generic.List<JObject>();
            
            foreach (var backend in backends)
            {
                string cacheKey = context.Variables.GetValueOrDefault<string>("cacheKeyPrefix") + backend["id"].ToString();
                string healthStatus = null;
                
                if (context.Cache.TryGetValue(cacheKey, out healthStatus))
                {
                    if (healthStatus == "healthy")
                    {
                        healthyList.Add(backend);
                    }
                }
                else
                {
                    healthyList.Add(backend);
                }
            }
            
            if (healthyList.Count == 0)
            {
                return backends;
            }
            
            return healthyList.ToArray();
        }" />
        
        <!-- Session affinity logic -->
        <choose>
            <when condition="@(context.Request.Headers.GetValueOrDefault("Cookie","").Contains("APIM-Backend-Instance"))">
                <set-variable name="requestedInstance" value="@{
                    string cookie = context.Request.Headers.GetValueOrDefault("Cookie","");
                    var match = System.Text.RegularExpressions.Regex.Match(cookie, @"APIM-Backend-Instance=(\d+)");
                    return match.Success ? match.Groups[1].Value : null;
                }" />
                
                <set-variable name="backendInstance" value="@{
                    string requestedId = context.Variables.GetValueOrDefault<string>("requestedInstance");
                    var healthyBackends = (JObject[])context.Variables["healthyBackends"];
                    
                    if (requestedId != null)
                    {
                        foreach (var backend in healthyBackends)
                        {
                            if (backend["id"].ToString() == requestedId)
                            {
                                return requestedId;
                            }
                        }
                    }
                    
                    var random = new Random();
                    int idx = random.Next(0, healthyBackends.Length);
                    return healthyBackends[idx]["id"].ToString();
                }" />
            </when>
            <otherwise>
                <set-variable name="backendInstance" value="@{
                    var healthyBackends = (JObject[])context.Variables["healthyBackends"];
                    var random = new Random();
                    int idx = random.Next(0, healthyBackends.Length);
                    return healthyBackends[idx]["id"].ToString();
                }" />
            </otherwise>
        </choose>
        
        <!-- Set the backend URL -->
        <set-variable name="selectedBackend" value="@{
            string instanceId = context.Variables.GetValueOrDefault<string>("backendInstance");
            var backends = (JObject[])context.Variables["backends"];
            
            foreach (var backend in backends)
            {
                if (backend["id"].ToString() == instanceId)
                {
                    return backend;
                }
            }
            
            return backends[0];
        }" />
        
        <set-backend-service base-url="@{
            var backend = (JObject)context.Variables["selectedBackend"];
            return backend["url"].ToString();
        }" />
        
        <set-header name="X-APIM-Correlation-Id" exists-action="skip">
            <value>@(Guid.NewGuid().ToString())</value>
        </set-header>
        
        <set-header name="X-Backend-Instance" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("backendInstance", "0"))</value>
        </set-header>
    </inbound>
    
    <backend>
        <base />
    </backend>
    
    <outbound>
        <base />
        
        <!-- Monitor backend response and update health status -->
        <choose>
            <when condition="@(context.Response.StatusCode >= 500 || context.Response.StatusCode == 429)">
                <!-- Mark backend as unhealthy on 5xx or 429 errors -->
                <cache-store-value key="@(context.Variables.GetValueOrDefault<string>("cacheKeyPrefix") + context.Variables.GetValueOrDefault<string>("backendInstance"))" value="unhealthy" duration="30" />
            </when>
            <when condition="@(context.Response.StatusCode >= 200 && context.Response.StatusCode < 300)">
                <!-- Mark backend as healthy on successful response -->
                <cache-store-value key="@(context.Variables.GetValueOrDefault<string>("cacheKeyPrefix") + context.Variables.GetValueOrDefault<string>("backendInstance"))" value="healthy" duration="30" />
            </when>
        </choose>
        
        <set-header name="Set-Cookie" exists-action="append">
            <value>@{
                string instance = context.Variables.GetValueOrDefault<string>("backendInstance", "0");
                return $"APIM-Backend-Instance={instance}; Path=/; Max-Age=86400; HttpOnly; Secure; SameSite=Lax";
            }</value>
        </set-header>
        
        <set-header name="X-Served-By-Instance" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("backendInstance", "0"))</value>
        </set-header>
    </outbound>
    
    <on-error>
        <base />
        
        <!-- Mark backend as unhealthy on errors -->
        <cache-store-value key="@(context.Variables.GetValueOrDefault<string>("cacheKeyPrefix") + context.Variables.GetValueOrDefault<string>("backendInstance", "unknown"))" value="unhealthy" duration="30" />
        
        <set-header name="X-Error-Backend-Instance" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("backendInstance", "unknown"))</value>
        </set-header>
    </on-error>
</policies>
