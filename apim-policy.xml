<!--
    Azure API Management Policy for Load Balancing with Session Affinity and Circuit Breaker
    
    Features:
    - Cookie-based session affinity (sticky sessions)
    - Automatic circuit breaking based on backend health
    - Failover to healthy instances when backend returns 500, 429, or 401
    - Automatic recovery when backends return 200 OK
    
    Apply this policy at the API level for your main endpoints
-->
<policies>
    <inbound>
        <base />
        
        <!-- Check for healthy backends from cache -->
        <set-variable name="healthyBackends" value="@{
            var allBackends = new[] { "0", "1", "2", "3", "4" };
            var healthyList = new System.Collections.Generic.List<string>();
            
            foreach (var id in allBackends)
            {
                string cacheKey = "backend-health-" + id;
                string healthStatus;
                
                if (context.Cache.TryGetValue(cacheKey, out healthStatus))
                {
                    if (healthStatus == "healthy")
                    {
                        healthyList.Add(id);
                    }
                }
                else
                {
                    healthyList.Add(id);
                }
            }
            
            return healthyList.Count > 0 ? healthyList.ToArray() : allBackends;
        }" />
        
        <!-- Session affinity with health check -->
        <choose>
            <when condition="@(context.Request.Headers.GetValueOrDefault("Cookie","").Contains("APIM-Backend-Instance"))">
                <set-variable name="backendInstance" value="@{
                    string cookie = context.Request.Headers.GetValueOrDefault("Cookie","");
                    var match = System.Text.RegularExpressions.Regex.Match(cookie, @"APIM-Backend-Instance=(\d+)");
                    string requestedId = match.Success ? match.Groups[1].Value : null;
                    var healthyBackends = (string[])context.Variables["healthyBackends"];
                    
                    if (requestedId != null && healthyBackends.Contains(requestedId))
                    {
                        return requestedId;
                    }
                    
                    var random = new Random();
                    return healthyBackends[random.Next(0, healthyBackends.Length)];
                }" />
            </when>
            <otherwise>
                <set-variable name="backendInstance" value="@{
                    var healthyBackends = (string[])context.Variables["healthyBackends"];
                    var random = new Random();
                    return healthyBackends[random.Next(0, healthyBackends.Length)];
                }" />
            </otherwise>
        </choose>
        
        <!-- Set backend URL based on instance ID -->
        <set-backend-service base-url="@{
            string id = context.Variables.GetValueOrDefault<string>("backendInstance", "0");
            var backends = new System.Collections.Generic.Dictionary<string, string> {
                { "0", "https://your-app-instance-1.azurecontainerapps.io" },
                { "1", "https://your-app-instance-2.azurecontainerapps.io" },
                { "2", "https://your-app-instance-3.azurecontainerapps.io" },
                { "3", "https://your-app-instance-4.azurecontainerapps.io" },
                { "4", "https://your-app-instance-5.azurecontainerapps.io" }
            };
            return backends.ContainsKey(id) ? backends[id] : backends["0"];
        }" />
        
        <set-header name="X-APIM-Correlation-Id" exists-action="skip">
            <value>@(Guid.NewGuid().ToString())</value>
        </set-header>
        
        <set-header name="X-Backend-Instance" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("backendInstance", "0"))</value>
        </set-header>
    </inbound>
    
    <backend>
        <base />
    </backend>
    
    <outbound>
        <base />
        
        <!-- Circuit breaker: Update health status based on response -->
        <choose>
            <when condition="@(context.Response.StatusCode >= 500 || context.Response.StatusCode == 429 || context.Response.StatusCode == 401)">
                <!-- Mark backend as unhealthy for 30 seconds on errors -->
                <cache-store-value key="@("backend-health-" + context.Variables.GetValueOrDefault<string>("backendInstance"))" value="unhealthy" duration="30" />
            </when>
            <when condition="@(context.Response.StatusCode == 200)">
                <!-- Mark backend as healthy on 200 OK response -->
                <cache-store-value key="@("backend-health-" + context.Variables.GetValueOrDefault<string>("backendInstance"))" value="healthy" duration="30" />
            </when>
        </choose>
        
        <!-- Set session affinity cookie -->
        <set-header name="Set-Cookie" exists-action="append">
            <value>@{
                string instance = context.Variables.GetValueOrDefault<string>("backendInstance", "0");
                return $"APIM-Backend-Instance={instance}; Path=/; Max-Age=86400; HttpOnly; Secure; SameSite=Lax";
            }</value>
        </set-header>
        
        <set-header name="X-Served-By-Instance" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("backendInstance", "0"))</value>
        </set-header>
    </outbound>
    
    <on-error>
        <base />
        
        <!-- Circuit breaker: Mark backend as unhealthy on connection errors -->
        <cache-store-value key="@("backend-health-" + context.Variables.GetValueOrDefault<string>("backendInstance", "0"))" value="unhealthy" duration="30" />
        
        <set-header name="X-Error-Backend-Instance" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("backendInstance", "unknown"))</value>
        </set-header>
    </on-error>
</policies>
